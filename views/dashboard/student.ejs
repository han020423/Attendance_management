<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <%
    const statusMap = {
      'SCHEDULED': '예정',
      'OPEN': '진행중',
      'CLOSED': '종료',
      'CANCELED': '취소'
    };
    const getStatusText = (status) => statusMap[status] || status;
  %>
</head>
<body>
  <h1><%= title %></h1>
  <p><%= user.name %>님, 환영합니다. (<a href="#" onclick="document.getElementById('logout-form').submit();">로그아웃</a>)</p>
  <form id="logout-form" action="/auth/logout" method="post" style="display: none;"></form>

  <nav>
    <a href="/courses">내 수강과목</a> |
    <a href="/excuses/me">내 공결 신청</a> |
    <a href="/messages">메시지함</a> |
    <a href="/me/notifications">내 알림</a><% if (locals.unreadNotificationCount && unreadNotificationCount > 0) { %><span class="notification-count"><%= unreadNotificationCount %></span><% } %>
  </nav>

  <h2>오늘의 수업</h2>
  <% if (todaySessions.length > 0) { %>
    <ul>
    <% todaySessions.forEach(session => { %>
      <li>
        <strong><%= session.Course.title %></strong>
        (<%= session.start_at %> - <%= session.end_at %>) - <strong><%= getStatusText(session.status) %></strong>
        
        <% if (session.status === 'OPEN') { %>
          <% if (session.attendance && session.attendance.status === 1) { %>
            <span>✅ 출석 완료</span>
          <% } else if (session.attendance && session.attendance.status === 2) { %>
            <span>⚠️ 지각</span>
          <% } else { %>
            <form action="/sessions/<%= session.id %>/attend" method="post" style="display: inline;">
              <input type="text" name="pin" placeholder="인증번호" required>
              <input type="hidden" name="method" value="PIN">
              <button type="submit">출석하기</button>
            </form>
          <% } %>
        <% } else if (session.status === 'CLOSED') { %>
            <% if (session.attendance && session.attendance.status === 1) { %>
              <span>✅ 출석</span>
            <% } else if (session.attendance && session.attendance.status === 2) { %>
              <span>⚠️ 지각</span>
            <% } else if (session.attendance && session.attendance.status === 4) { %>
              <span>👍 공결</span>
            <% } else { %>
              <span>❌ 결석</span>
            <% } %>
            <a href="/excuses/new/session/<%= session.id %>">공결 신청</a>
        <% } else { %>
          <span>(<%= getStatusText(session.status) %>)</span>
        <% } %>
      </li>
    <% }) %>
    </ul>
  <% } else { %>
    <p>오늘 수업이 없습니다.</p>
  <% } %>
</body>
</html>
