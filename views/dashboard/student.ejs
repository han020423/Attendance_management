<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <%
    const statusMap = {
      'SCHEDULED': 'ì˜ˆì •',
      'OPEN': 'ì§„í–‰ì¤‘',
      'CLOSED': 'ì¢…ë£Œ',
      'CANCELED': 'ì·¨ì†Œ'
    };
    const getStatusText = (status) => statusMap[status] || status;
  %>
</head>
<body>
  <h1><%= title %></h1>
  <p><%= user.name %>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤. (<a href="#" onclick="document.getElementById('logout-form').submit();">ë¡œê·¸ì•„ì›ƒ</a>)</p>
  <form id="logout-form" action="/auth/logout" method="post" style="display: none;"></form>

  <nav>
    <a href="/courses">ë‚´ ìˆ˜ê°•ê³¼ëª©</a> |
    <a href="/excuses/me">ë‚´ ê³µê²° ì‹ ì²­</a> |
    <a href="/messages">ë©”ì‹œì§€í•¨</a> |
    <a href="/me/notifications">ë‚´ ì•Œë¦¼</a><% if (locals.unreadNotificationCount && unreadNotificationCount > 0) { %><span class="notification-count"><%= unreadNotificationCount %></span><% } %>
  </nav>

  <h2>ì˜¤ëŠ˜ì˜ ìˆ˜ì—…</h2>
  <% if (todaySessions.length > 0) { %>
    <ul>
    <% todaySessions.forEach(session => { %>
      <li class="session-item">
        <div class="session-info">
          <strong><%= session.Course.title %></strong>
          (<%= session.start_at %> - <%= session.end_at %>) - <strong><%= getStatusText(session.status) %></strong>
        </div>
        
        <div class="session-action">
          <% if (session.status === 'OPEN') { %>
            <% if (session.attendance && session.attendance.status === 1) { %>
              <span class="attendance-status-badge status-complete">âœ… ì¶œì„ ì™„ë£Œ</span>
            <% } else if (session.attendance && session.attendance.status === 2) { %>
              <span class="attendance-status-badge status-late">âš ï¸ ì§€ê°</span>
            <% } else { %>
              <form class="attend-form" action="/sessions/<%= session.id %>/attend" method="post">
                <input type="text" name="pin" placeholder="ì¸ì¦ë²ˆí˜¸" required>
                <input type="hidden" name="method" value="PIN">
                <button type="submit">ì¶œì„í•˜ê¸°</button>
              </form>
            <% } %>
          <% } else if (session.status === 'CLOSED') { %>
              <% if (session.attendance && session.attendance.status === 1) { %>
                <span class="attendance-status-badge status-complete">âœ… ì¶œì„</span>
              <% } else if (session.attendance && session.attendance.status === 2) { %>
                <span class="attendance-status-badge status-late">âš ï¸ ì§€ê°</span>
              <% } else if (session.attendance && session.attendance.status === 4) { %>
                <span class="attendance-status-badge status-excused">ğŸ‘ ê³µê²°</span>
              <% } else { %>
                <span class="attendance-status-badge status-absent">âŒ ê²°ì„</span>
              <% } %>
              <a href="/excuses/new/session/<%= session.id %>" class="btn-link">ê³µê²° ì‹ ì²­</a>
          <% } else { %>
            <span>(<%= getStatusText(session.status) %>)</span>
          <% } %>
        </div>
      </li>
    <% }) %>
    </ul>
  <% } else { %>
    <p>ì˜¤ëŠ˜ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  <% } %>

<script>
  // í‘¸ì‹œ ì•Œë¦¼ì„ í‘œì‹œí•  ì»¨í…Œì´ë„ˆ ìƒì„±
  let notificationContainer = document.getElementById('push-notification-container');
  if (!notificationContainer) {
    notificationContainer = document.createElement('div');
    notificationContainer.id = 'push-notification-container';
    document.body.appendChild(notificationContainer);
  }

  // í‘¸ì‹œ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
  function showPushNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'push-notification';
    notification.textContent = message;
    notificationContainer.appendChild(notification);

    // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„(5ì´ˆ) DOMì—ì„œ ìš”ì†Œ ì œê±°
    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  // í•™ìƒì¼ ê²½ìš°ì—ë§Œ SSE ì—°ê²°
  <% if (user && user.role === 'STUDENT') { %>
    const eventSource = new EventSource('/sse/connect');

    eventSource.onmessage = function(event) {
      try {
        const notification = JSON.parse(event.data);
        if (notification && notification.message) {
          showPushNotification(notification.message);
        }
      } catch (e) {
        console.error('Error parsing notification data:', e);
      }
    };

    eventSource.onerror = function(err) {
      console.error("EventSource failed:", err);
      // ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ì¬ì—°ê²°ì„ ì‹œë„í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì—ëŸ¬ ë¡œê¹…ë§Œ í•©ë‹ˆë‹¤.
    };
  <% } %>
</script>
</body>
</html>
